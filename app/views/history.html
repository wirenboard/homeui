<h1 class="page-header">
    History
</h1>

<div class="row" ng-repeat="sel in $ctrl.selectedTopics track by $index">
    <div class="col-xs-7">
        <select id="control-select"
                class="form-control"
                ng-disabled="$ctrl.pend"
                ng-change="$ctrl.updateUrl($index)"
                ng-model="$ctrl.selectedTopics[$index]"
                ng-options="control.topic as control.name for control in $ctrl.controls">
            <option value="">- Please Choose -</option>
        </select>
    </div>
    <div class="col-xs-4">
        <div ng-hide="($index==0 && $ctrl.selectedTopics.length==1) || !$ctrl.selectedTopics[1]"
             class="btn btn-danger" ng-click="$ctrl.deleteTopic($index)">delete
        </div>
    </div>
</div>
<div ng-hide="$ctrl.selectedTopics.length==1 && !$ctrl.selectedTopics[$ctrl.selectedTopics.length-1]">
    <br>
    <button class="btn btn-success" ng-click="$ctrl.addTopic()">
        Add channel
    </button>
    <br>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="row" ng-show="$ctrl.topics.length">
            <div class="col-xs-1 history-time-col-l">
                <label for="history-start">Start</label>
            </div>
            <div class="col-xs-8 history-time-col-r">
                <div class="input-group">
                    <input id="history-start"
                           type="text"
                           class="form-control"
                           uib-datepicker-popup="{{format}}"
                           ng-change="$ctrl.onlyTimeUpdate()"
                           ng-model="$ctrl.selectedStartDate"
                           is-open="$ctrl.popups.start"
                           datepicker-options="$ctrl.dateOptionsStart"
                           close-text="Close"/>
              <span class="input-group-btn">
                <button type="button" class="btn btn-default" ng-click="$ctrl.popups.start = true"><i
                        class="glyphicon glyphicon-calendar"></i></button>
              </span>
                </div>
            </div>
            <div class="col-xs-3">
                <div uib-timepicker
                     ng-model="$ctrl.selectedStartDateMinute"
                     ng-model-options="{'debounce':3000}"
                     ng-change="$ctrl.onlyTimeUpdate()"
                     minute-step="5" hour-step="1"
                     show-meridian="false"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="row" ng-show="$ctrl.topics.length">
            <div class="col-xs-1 history-time-col-l">
                <label for="history-start">End</label>
            </div>
            <div class="col-xs-8 history-time-col-r">
                <div class="input-group">
                    <input id="history-end"
                           type="text"
                           class="form-control"
                           uib-datepicker-popup="{{format}}"
                           ng-change="$ctrl.onlyTimeUpdate()"
                           ng-model="$ctrl.selectedEndDate"
                           is-open="$ctrl.popups.end"
                           datepicker-options="$ctrl.dateOptionsEnd"
                           close-text="Close"/>
                  <span class="input-group-btn">
                    <button type="button" class="btn btn-default" ng-click="$ctrl.popups.end = true"><i
                            class="glyphicon glyphicon-calendar"></i></button>
                  </span>
                </div>
            </div>
            <div class="col-xs-3">
                <div uib-timepicker
                     ng-model="$ctrl.selectedEndDateMinute"
                     ng-model-options="{'debounce':3000}"
                     ng-change="$ctrl.onlyTimeUpdate()"
                     minute-step="5" hour-step="1"
                     show-meridian="false"></div>
            </div>
        </div>
    </div>
</div>

<div ng-show="$ctrl.plotlyStartDate">
    <button class="btn btn-success" ng-click="$ctrl.changeDateByPlotly()">
        Load more data
    </button>
    <br><br>
</div>

<div class="col-sm-12 spinner" ng-cloak
     ng-show="$ctrl.pend || (!$ctrl.firstChunkIsLoaded && !$ctrl.selectedTopics.length)">
    <span class="spinner-loader">Loading...</span>
</div>

<div oc-lazy-load="['https://cdn.plot.ly/plotly-latest.min.js']">
    <div class="col-sm-12" ng-if="$ctrl.firstChunkIsLoaded">
        <plotly plotly-events="$ctrl.plotlyEvents"
                plotly-data="$ctrl.chartConfig"
                plotly-layout="$ctrl.layoutConfig"
                plotly-options="$ctrl.options"
                ng-hide="$ctrl.hasString || !$ctrl.hasPoints"></plotly>
        <br>
        <div class="history-empty"
             ng-show="(this.chartConfig[0].x.length && !$ctrl.dataPoints.length) || !$ctrl.hasPoints">
            No data points to display.
        </div>
    </div>
    <!--<div class="history-empty"
         ng-show="$ctrl.hasString">
        No points for graph.
    </div>-->
</div>


<div class="col-xs-12 col-md-6 col-lg-4" ng-if="$ctrl.dataPoints.length && $ctrl.hasPoints">
    <table class="table">
        <thead>
            <tr>
                <th>Date and time</th>
                <th>{{$ctrl.channelNames[0]}}</th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="p in $ctrl.dataPoints track by $index">
                <td>{{ p.x | date:'yyyy-MM-dd HH:mm:ss' }}</td>
                <td>{{ p.y }}</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="col-xs-12" ng-if="$ctrl.dataPointsMultiple.length && $ctrl.hasPoints">
    <table class="table">
        <thead>
        <tr>
            <th>Date and time</th>
            <th ng-repeat="name in $ctrl.channelNames">{{name}}</th>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="p in $ctrl.dataPointsMultiple track by p.date">
            <td>{{ p.date | date:'yyyy-MM-dd HH:mm:ss' }}</td>
            <td ng-repeat="_x in p.value track by $index">{{ _x }}</td>
        </tr>
        </tbody>
    </table>
</div>
