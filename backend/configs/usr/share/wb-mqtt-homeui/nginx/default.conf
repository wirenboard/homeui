# Configuration for Wiren Board Homeui web interface
#
# DO NOT EDIT THIS FILE DIRECTLY! It will be overwritten by the deb package upgrade
#
# Add your custom configuration to /etc/nginx/includes/default.wb.d/*.conf
# Change listen settings in /etc/nginx/includes/default.wb.d/listen.conf


upload_progress fwupdate 1M;

upstream wb-homeui-back {
	server unix:/tmp/wb-homeui.socket;
}

upstream mosquitto-user {
	server 127.0.0.1:18884;
}

upstream mosquitto-operator {
	server 127.0.0.1:18885;
}

upstream mosquitto-admin {
	server 127.0.0.1:18886;
}

upstream mosquitto-legacy {
	server 127.0.0.1:18883;
}

map $wb_user_type $mosquitto_upstream {
	"admin" "mosquitto-admin";
	"operator" "mosquitto-operator";
	"user" "mosquitto-user";
	default "mosquitto-legacy";
}

server {
	include /etc/nginx/includes/default.wb.d/*.conf;
	include /var/lib/wb-homeui/nginx/*.conf;
	include /usr/share/wb-mqtt-homeui/nginx/includes/*.conf;

	root /var/www;

	gzip on;
	gzip_comp_level 6;
	gzip_buffers 16 8k;
	gzip_min_length 1200;
	gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript application/font-woff image/svg+xml;

	# Make site accessible from http://localhost/
	server_name localhost;

	location / {
		index index.html;
		try_files $uri $uri/ /index.html;
		add_header Cache-Control "no-store, no-cache, must-revalidate";
	}

	location ~* \.(js|jpg|jpeg|gif|png|svg|css|json)$ {
		add_header Cache-Control "max-age=31536000";
	}

	location /api/check {

		limit_except GET {
			deny all;
		}

		set $required_user_type "user";
		auth_request /auth/check;

		fastcgi_param SCRIPT_FILENAME /usr/lib/cgi-bin/check.sh;
		fastcgi_param HTTP_SCHEME $scheme;
		fastcgi_param SCRIPT_NAME check.sh;
		fastcgi_param QUERY_STRING $query_string;
		fastcgi_param REQUEST_METHOD $request_method;
		fastcgi_param CONTENT_TYPE $content_type;
		fastcgi_param CONTENT_LENGTH $content_length;
		fastcgi_param REQUEST_URI $request_uri;
		fastcgi_pass unix:/var/run/fcgiwrap.socket;

	}

	location /fwupdate/download/rootfs {

		limit_except GET {
			deny all;
		}

		auth_request /auth/check;

		fastcgi_param SCRIPT_FILENAME /usr/lib/cgi-bin/download_rootfs.sh;
		fastcgi_param SCRIPT_NAME download_rootfs.sh;
		fastcgi_param QUERY_STRING $query_string;
		fastcgi_param REQUEST_METHOD $request_method;
		fastcgi_param CONTENT_TYPE $content_type;
		fastcgi_param CONTENT_LENGTH $content_length;
		fastcgi_param REQUEST_URI $request_uri;
		fastcgi_pass unix:/var/run/fcgiwrap.socket;
		fastcgi_request_buffering off;  # to allow stream-downloading via backend

	}

	location /fwupdate/download/configs {

		limit_except GET {
			deny all;
		}

		auth_request /auth/check;

		fastcgi_param SCRIPT_FILENAME /usr/lib/cgi-bin/download_configs.sh;
		fastcgi_param SCRIPT_NAME download_configs.sh;
		fastcgi_param QUERY_STRING $query_string;
		fastcgi_param REQUEST_METHOD $request_method;
		fastcgi_param CONTENT_TYPE $content_type;
		fastcgi_param CONTENT_LENGTH $content_length;
		fastcgi_param REQUEST_URI $request_uri;
		fastcgi_pass unix:/var/run/fcgiwrap.socket;
		fastcgi_request_buffering off;  # to allow stream-downloading via backend

	}

	location /fwupdate/download/everything {

		limit_except GET {
			deny all;
		}

		auth_request /auth/check;

		fastcgi_param SCRIPT_FILENAME /usr/lib/cgi-bin/download_everything.sh;
		fastcgi_param SCRIPT_NAME download_everything.sh;
		fastcgi_param QUERY_STRING $query_string;
		fastcgi_param REQUEST_METHOD $request_method;
		fastcgi_param CONTENT_TYPE $content_type;
		fastcgi_param CONTENT_LENGTH $content_length;
		fastcgi_param REQUEST_URI $request_uri;
		fastcgi_pass unix:/var/run/fcgiwrap.socket;
		fastcgi_request_buffering off;  # to allow stream-downloading via backend

	}

	location /api/serial-custom-templates {
		limit_except GET POST DELETE {
			deny all;
		}

		set $required_user_type "operator";
		auth_request /auth/check;

		client_max_body_size 1M;
		gzip off;

		fastcgi_param TEMPLATES_DIR /etc/wb-mqtt-serial.conf.d/templates;
		fastcgi_param SCRIPT_FILENAME /usr/lib/cgi-bin/wb_mqtt_serial_custom_templates.py;
		fastcgi_param SCRIPT_NAME wb_mqtt_serial_custom_templates.py;
		fastcgi_param QUERY_STRING $query_string;
		fastcgi_param REQUEST_METHOD $request_method;
		fastcgi_param CONTENT_TYPE $content_type;
		fastcgi_param CONTENT_LENGTH $content_length;
		fastcgi_param REQUEST_URI $request_uri;
		fastcgi_pass unix:/var/run/fcgiwrap.socket;
	}

	location /fwupdate/upload {
		limit_except POST {
			deny all;
		}
		client_body_buffer_size 128K;
		client_max_body_size 1000M;

		gzip off;

		auth_request /auth/check;

		fastcgi_param UPLOADS_DIR /var/www/uploads;
		fastcgi_param SCRIPT_FILENAME /usr/lib/cgi-bin/fwupdate_upload.py;
		fastcgi_param SCRIPT_NAME fwupdate_upload.py;
		fastcgi_param QUERY_STRING $query_string;
		fastcgi_param REQUEST_METHOD $request_method;
		fastcgi_param CONTENT_TYPE $content_type;
		fastcgi_param CONTENT_LENGTH $content_length;
		fastcgi_param REQUEST_URI $request_uri;
		fastcgi_pass unix:/var/run/fcgiwrap.socket;
		fastcgi_request_buffering off;  # to allow stream-downloading via backend

		track_uploads fwupdate 5s;
	}

	location /fwupdate/factoryreset {
		limit_except POST {
			deny all;
		}
		gzip off;

		auth_request /auth/check;

		fastcgi_param SCRIPT_FILENAME /usr/lib/cgi-bin/factory_reset.py;
		fastcgi_param SCRIPT_NAME factory_reset.py;
		fastcgi_param QUERY_STRING $query_string;
		fastcgi_param REQUEST_METHOD $request_method;
		fastcgi_param CONTENT_TYPE $content_type;
		fastcgi_param CONTENT_LENGTH $content_length;
		fastcgi_param REQUEST_URI $request_uri;
		fastcgi_pass unix:/var/run/fcgiwrap.socket;
	}

	location /fwupdate/progress {
		auth_request /auth/check;

		report_uploads fwupdate;
	}

	location /mqtt {
		set $required_user_type "user";
		auth_request /auth/check;
		auth_request_set $wb_user_type $sent_http_wb_user_type;

		proxy_pass http://$mosquitto_upstream;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection upgrade;
	}

	location /auth/check {
		internal;
		client_max_body_size 1000M;
		proxy_pass_request_body off;
		proxy_set_header Content-Length "";
		proxy_set_header Required-User-Type $required_user_type;
		proxy_set_header Allow-Unauthorized-Get $allow_unauthorized_get;
		proxy_set_header X-Original-Method $request_method;
		proxy_pass http://wb-homeui-back/auth/check;
	}

	location /auth/users {
		set $required_user_type "admin";
		auth_request /auth/check;

		proxy_pass http://wb-homeui-back/users;
	}

	location /auth/login {
		limit_except POST {
			deny all;
		}
		proxy_pass http://wb-homeui-back/auth/login;
	}

	location /auth/logout {
		limit_except POST {
			deny all;
		}
		proxy_pass http://wb-homeui-back/auth/logout;
	}

	location /auth/who_am_i {
		limit_except GET {
			deny all;
		}
		proxy_pass http://wb-homeui-back/auth/who_am_i;
	}

	location /device/info {
		limit_except GET {
			deny all;
		}
		proxy_set_header X-Forwarded-Host-Ip $server_addr;
		proxy_pass http://wb-homeui-back/device/info;
	}

	location /api/https/request_cert {
		limit_except POST {
			deny all;
		}
		proxy_pass http://wb-homeui-back/api/https/request_cert;
	}

	location /api/https {
		set $allow_unauthorized_get "true";
		auth_request /auth/check;

		proxy_pass http://wb-homeui-back/api/https;
	}

	location /ui/menu {
		limit_except GET {
			deny all;
		}
		proxy_pass http://wb-homeui-back/ui/menu;
	}
}
